# Мультитенантность: настройка и использование

## Что было реализовано

### 1. Модели данных и миграции

- ✅ Добавлены таблицы: `tg_chats`, `chat_admins`, `chat_members`
- ✅ Обновлены модели: `Tournament.chat_id`, `PlayerModeStats.chat_id`
- ✅ Создана Alembic миграция: `001_add_telegram_chats.py`

### 2. Backend API

- ✅ `GET /chats` - список групп для пользователя
- ✅ `GET /chats/{chat_id}` - информация о группе
- ✅ `POST /bot/chats/register` - регистрация чата (для бота)
- ✅ `POST /bot/chats/members/sync` - синхронизация участников (для бота)
- ✅ `POST /bot/chats/members/update` - обновление одного участника (для бота)
- ✅ Обновлён `POST /tournaments` - требует `chat_id` через query параметр
- ✅ Обновлены эндпоинты для фильтрации по `chat_id`:
  - `GET /rating/{mode}?chat_id=...`
  - `GET /players?chat_id=...`
  - `GET /players/search?chat_id=...`

### 3. Авторизация

- ✅ Модуль `backend/auth.py` с функциями:
  - `get_current_user()` - получение пользователя по заголовку `X-User-Tg-Id`
  - `check_chat_admin_access()` - проверка прав доступа к чату
  - `get_user_chats()` - получение списка чатов пользователя

### 4. Telegram Bot

- ✅ Обработчик добавления бота в группу (`handle_my_chat_member`)
- ✅ Обработчик новых участников (`handle_new_chat_members`)
- ✅ Обработчик ухода участников (`handle_left_chat_member`)
- ✅ Команда `/sync` для синхронизации участников

### 5. Frontend

- ✅ Компонент `ChatSelector` для выбора группы
- ✅ Хранение `activeChatId` в `localStorage`
- ✅ Утилиты API (`api.ts`) для работы с заголовками
- ✅ Экран выбора группы при старте

## Установка и настройка

### 1. Применить миграции

```bash
# Установить зависимости
pip install -r requirements.txt

# Применить миграции
alembic upgrade head
```

### 2. Настройка переменных окружения

Для бота:
```env
BOT_TOKEN=your_bot_token
BACKEND_URL=http://localhost:8000
WEBAPP_URL=http://localhost:5173
```

Для backend:
```env
DATABASE_URL=postgresql://user:pass@localhost/dbname
```

### 3. Запуск

```bash
# Backend
cd backend
uvicorn main:app --reload

# Bot
cd bot
python bot.py

# Frontend
cd web
npm install
npm run dev
```

## Использование

### Для админа группы

1. **Добавьте бота в Telegram группу**
   - Бот автоматически зарегистрирует группу в базе данных

2. **Синхронизация участников**
   - В группе выполните команду `/sync`
   - Или участники будут синхронизированы автоматически при добавлении/удалении

3. **Работа в веб-приложении**
   - При первом запуске выберите группу из списка
   - Выбранная группа сохраняется в localStorage
   - Все действия привязаны к выбранной группе

### API запросы

Все запросы к API должны включать:
- Заголовок `X-User-Tg-Id: <telegram_user_id>` для идентификации пользователя
- Заголовок `X-Chat-Id: <chat_id>` или query параметр `?chat_id=<chat_id>` для указания группы

Пример:
```bash
curl -X GET "http://localhost:8000/chats" \
  -H "X-User-Tg-Id: 123456789"
```

## Тестирование (Manual QA Checklist)

### 1. Регистрация группы
- [ ] Добавить бота в новую группу
- [ ] Проверить, что группа появилась в базе данных (`tg_chats`)
- [ ] Проверить, что админы группы добавлены в `chat_admins`

### 2. Синхронизация участников
- [ ] Выполнить `/sync` в группе
- [ ] Проверить, что участники добавлены в `chat_members`
- [ ] Добавить нового участника в группу
- [ ] Проверить, что он автоматически появился в базе

### 3. Веб-приложение
- [ ] Открыть веб-приложение
- [ ] Указать `userTgId` (можно через localStorage или UI)
- [ ] Проверить, что отображается список групп
- [ ] Выбрать группу
- [ ] Создать турнир
- [ ] Проверить, что турнир привязан к выбранной группе

### 4. Проверка прав доступа
- [ ] Попробовать создать турнир без прав админа (должна быть ошибка 403)
- [ ] Попробовать получить список групп для несуществующего пользователя (должна быть ошибка 404)

### 5. Фильтрация данных
- [ ] Создать турниры в разных группах
- [ ] Проверить, что рейтинг фильтруется по группе
- [ ] Проверить, что список игроков фильтруется по группе

## Известные ограничения

1. **Telegram API ограничения**: В больших группах (>200 участников) `/sync` может не получить всех участников. Используйте события `new_chat_members` для инкрементальной синхронизации.

2. **Авторизация**: Сейчас используется упрощённая схема через заголовок `X-User-Tg-Id`. В продакшене рекомендуется использовать JWT или OAuth.

3. **Обратная совместимость**: Старые турниры могут иметь `chat_id = NULL`. Их можно обработать скриптом backfill.

## Дальнейшие улучшения

1. Добавить UI для ввода `userTgId` в веб-приложении
2. Реализовать полную синхронизацию участников через Telegram Webhook
3. Добавить фильтрацию турниров по группе в API
4. Добавить статистику по группам
5. Реализовать полноценную систему ролей (owner/admin/member)

